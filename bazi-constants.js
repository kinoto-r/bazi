// bazi-constants.js
// ========================
// 四柱推命 基本定義（干支・五行・陰陽など）
// ========================

/* ===================== ベース定義 ===================== */
const stemElement = {
  '甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土',
  '庚':'金','辛':'金','壬':'水','癸':'水'
};

const branchElement = {
  '子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火',
  '午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'
};

const stemEl = s => stemElement[s] || '';

const gen = {'木':'火','火':'土','土':'金','金':'水','水':'木'};
const COUNTER = {'木':'土','火':'金','土':'水','金':'木','水':'火'};

const ZANG = {
  "子":{"hon":"癸","mid":null,"rem":"壬"},
  "丑":{"hon":"己","mid":"辛","rem":"癸"},
  "寅":{"hon":"甲","mid":"丙","rem":"戊"},
  "卯":{"hon":"乙","mid":null,"rem":"甲"},
  "辰":{"hon":"戊","mid":"癸","rem":"乙"},
  "巳":{"hon":"丙","mid":"庚","rem":"戊"},
  "午":{"hon":"丁","mid":null,"rem":"己"},
  "未":{"hon":"己","mid":"乙","rem":"丁"},
  "申":{"hon":"庚","mid":"壬","rem":"戊"},
  "酉":{"hon":"辛","mid":null,"rem":"庚"},
  "戌":{"hon":"戊","mid":"丁","rem":"辛"},
  "亥":{"hon":"壬","mid":null,"rem":"甲"}
};
// 蔵干深浅（節入からの日数で代表干を選ぶときに使用）
// 0日目を節入当日として、日数に応じて 6 区分に丸めて採用する。
// （表はユーザー提供の蔵干深浅表に基づく）
const ZANG_DEPTH_SEGMENTS = [6, 12, 18, 24, 30, 999];
const ZANG_DEPTH_TABLE = {
  '寅': ['甲','甲','丙','丙','甲','戊'],
  '卯': ['乙','乙','乙','乙','乙','乙'],
  '辰': ['戊','戊','乙','乙','乙','癸'],
  '巳': ['丙','丙','庚','庚','戊','丙'],
  '午': ['丁','丁','丁','丁','丁','丁'],
  '未': ['己','己','乙','乙','丁','丁'],
  '申': ['庚','庚','壬','壬','戊','庚'],
  '酉': ['辛','辛','辛','辛','辛','辛'],
  '戌': ['戊','戊','丁','丁','丁','辛'],
  '亥': ['壬','壬','壬','壬','壬','甲'],
  '子': ['癸','癸','癸','癸','癸','壬'],
  '丑': ['己','己','辛','辛','癸','癸'],
};

const BRANCH12 = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];

function normalizeBranch(b) {
  if (!b) return b;
  const s = String(b).replace(/\s+/g,'');
  if (BRANCH12.includes(s)) return s;
  for (const zhi of BRANCH12) {
    if (s.includes(zhi)) return zhi;
  }
  return b;
}

const YOJIN = {
  "建禄（比劫）格":{ "用神":["印綬/偏印"], "喜神":["比肩/劫財","印綬/偏印"], "忌神":["正官/偏官"], "仇神":["正財/偏財","食神/傷官"] },
  "印綬格":{ "用神":["比肩/劫財"], "喜神":["印綬/偏印"], "忌神":["正財/偏財"], "仇神":["食神/傷官","正官/偏官"] },
  "財格":{ "用神":["正官/偏官"], "喜神":["正財/偏財","食神/傷官"], "忌神":["比肩/劫財"], "仇神":["印綬/偏印"] },
  "官格（官殺格）":{ "用神":["印綬/偏印"], "喜神":["正官/偏官"], "忌神":["食神/傷官"], "仇神":["比肩/劫財","正財/偏財"] },
  "食傷格":{ "用神":["正財/偏財"], "喜神":["食神/傷官"], "忌神":["正官/偏官"], "仇神":["印綬/偏印"] },
  "従財格":{ "用神":["正財/偏財"], "喜神":["食神/傷官"], "忌神":["印綬/偏印"], "仇神":["比肩/劫財"] },
  "従殺格":{ "用神":["正官/偏官"], "喜神":["印綬/偏印"], "忌神":["食神/傷官"], "仇神":["比肩/劫財"] },
  "従児格":{ "用神":["食神/傷官"], "喜神":["正財/偏財"], "忌神":["正官/偏官"], "仇神":["印綬/偏印"] },
  "従強格":{ "用神":["比肩/劫財"], "喜神":["印綬/偏印"], "忌神":["正財/偏財"], "仇神":["正官/偏官","食神/傷官"] }
};

const YANG_STEMS = ['甲','丙','戊','庚','壬'];

function yinYangOfStem(stem) {
  return YANG_STEMS.includes(stem) ? '陽' : '陰';
}

const BRANCH_YIN_YANG = {
  子:'陽', 丑:'陰', 寅:'陽', 卯:'陰', 辰:'陽', 巳:'陰',
  午:'陽', 未:'陰', 申:'陽', 酉:'陰', 戌:'陽', 亥:'陰'
};

function yinYangOfBranch(branch) {
  return BRANCH_YIN_YANG[branch] || '';
}

const BRANCH_ELEMENT = {
  子:'水', 丑:'土', 寅:'木', 卯:'木', 辰:'土', 巳:'火',
  午:'火', 未:'土', 申:'金', 酉:'金', 戌:'土', 亥:'水'
};

function elementOfBranch(branch) {
  return BRANCH_ELEMENT[branch] || '';
}

const GUARDIAN_DEFAULT_STEM = {
  木:'甲', 火:'丙', 土:'戊', 金:'庚', 水:'癸'
};

// 九星簡易計算（節分まではざっくり対応・年だけで見る版）
// 例）1979 → 三碧木星, 1989 → 二黒土星, 2000 → 九紫火星
function kyuseiSimpleByYear(yearLike) {
  if (!yearLike) return '—';

  // 文字列でも数値でもOKにする
  let y;
  let m = null;
  let d = null;

  if (typeof yearLike === 'string' && yearLike.includes('-')) {
    // "1979-01-28" みたいなの
    const parts = yearLike.split('-');
    y = parseInt(parts[0], 10);
    m = parseInt(parts[1] || '0', 10);
    d = parseInt(parts[2] || '0', 10);
  } else {
    y = parseInt(yearLike, 10);
  }

  if (!y) return '—';

  // 節分ざっくり対応：2/4より前なら前年扱い
  if (m !== null && d !== null) {
    if (m < 2 || (m === 2 && d < 4)) {
      y = y - 1;
    }
  }

  // このロジックなら 1979 → 三碧 になります
  const n = 11 - (y % 9);
  const idx = ((n - 1 + 9) % 9) + 1;  // 1〜9に正規化

  const names = {
    1:'一白水星',
    2:'二黒土星',
    3:'三碧木星',
    4:'四緑木星',
    5:'五黄土星',
    6:'六白金星',
    7:'七赤金星',
    8:'八白土星',
    9:'九紫火星'
  };

  return names[idx] || '—';
}




// 十神ラベル分割（定義のみここに残す）
function splitTgLabel(raw) {
  if (!raw) return [];
  return String(raw).split(/[／\/]/).map(s => s.trim()).filter(Boolean);
}

const TEN_GOD_META = {
  '比肩': { el:'木', yy:'陽' }, '劫財': { el:'木', yy:'陰' },
  '食神': { el:'火', yy:'陽' }, '傷官': { el:'火', yy:'陰' },
  '偏財': { el:'土', yy:'陽' }, '正財': { el:'土', yy:'陰' },
  '偏官': { el:'金', yy:'陽' }, '正官': { el:'金', yy:'陰' },
  '偏印': { el:'水', yy:'陽' }, '印綬': { el:'水', yy:'陰' }
};

const BRANCH_META = {
  '子': { el:'水', yy:'陽' }, '丑': { el:'土', yy:'陰' }, '寅': { el:'木', yy:'陽' },
  '卯': { el:'木', yy:'陰' }, '辰': { el:'土', yy:'陽' }, '巳': { el:'火', yy:'陰' },
  '午': { el:'火', yy:'陽' }, '未': { el:'土', yy:'陰' }, '申': { el:'金', yy:'陽' },
  '酉': { el:'金', yy:'陰' }, '戌': { el:'土', yy:'陽' }, '亥': { el:'水', yy:'陰' }
};

const LIUHE = [['子','丑'],['寅','亥'],['卯','戌'],['辰','酉'],['巳','申'],['午','未']];
const CHONG = [['子','午'],['丑','未'],['寅','申'],['卯','酉'],['辰','戌'],['巳','亥']];
const HAI = [['子','未'],['丑','午'],['寅','巳'],['卯','辰'],['申','亥'],['酉','戌']];
const XING = [['子','卯'],['寅','巳'],['申','亥'],['丑','戌','未']];

const STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const JIAZI = Array.from({length:60}, (_,i) => STEMS[i%10] + BRANCHES[i%12]);
const KONGWANG_PAIRS = [
  ['戌','亥'], ['申','酉'], ['午','未'], ['辰','巳'], ['寅','卯'], ['子','丑']
];

const BRANCH_EMOJI = {
  子:'🐭', 丑:'🐮', 寅:'🐯', 卯:'🐰', 辰:'🐲', 巳:'🐍',
  午:'🐴', 未:'🐑', 申:'🐵', 酉:'🐔', 戌:'🐶', 亥:'🐷'
};

/* ===== 十二運星（日干基準） ===== */
const STAGE12 = {
  甲:{長生:'亥',沐浴:'子',冠帯:'丑',建禄:'寅',帝旺:'卯',衰:'辰',病:'巳',死:'午',墓:'未',絶:'申',胎:'酉',養:'戌'},
  乙:{長生:'午',沐浴:'巳',冠帯:'辰',建禄:'卯',帝旺:'寅',衰:'丑',病:'子',死:'亥',墓:'戌',絶:'酉',胎:'申',養:'未'},
  丙:{長生:'寅',沐浴:'卯',冠帯:'辰',建禄:'巳',帝旺:'午',衰:'未',病:'申',死:'酉',墓:'戌',絶:'亥',胎:'子',養:'丑'},
  丁:{長生:'酉',沐浴:'申',冠帯:'未',建禄:'午',帝旺:'巳',衰:'辰',病:'卯',死:'寅',墓:'丑',絶:'子',胎:'亥',養:'戌'},
  戊:{長生:'寅',沐浴:'卯',冠帯:'辰',建禄:'巳',帝旺:'午',衰:'未',病:'申',死:'酉',墓:'戌',絶:'亥',胎:'子',養:'丑'},
  己:{長生:'酉',沐浴:'申',冠帯:'未',建禄:'午',帝旺:'巳',衰:'辰',病:'卯',死:'寅',墓:'丑',絶:'子',胎:'亥',養:'戌'},
  庚:{長生:'巳',沐浴:'午',冠帯:'未',建禄:'申',帝旺:'酉',衰:'戌',病:'亥',死:'子',墓:'丑',絶:'寅',胎:'卯',養:'辰'},
  辛:{長生:'子',沐浴:'亥',冠帯:'戌',建禄:'酉',帝旺:'申',衰:'未',病:'午',死:'巳',墓:'辰',絶:'卯',胎:'寅',養:'丑'},
  壬:{長生:'申',沐浴:'酉',冠帯:'戌',建禄:'亥',帝旺:'子',衰:'丑',病:'寅',死:'卯',墓:'辰',絶:'巳',胎:'午',養:'未'},
  癸:{長生:'卯',沐浴:'寅',冠帯:'丑',建禄:'子',帝旺:'亥',衰:'戌',病:'酉',死:'申',墓:'未',絶:'午',胎:'巳',養:'辰'}
};

/* ===== 十二運星のエネルギー値 ===== */
const STAGE12_VALUES = {
  '胎': 3, '養': 6, '長生': 9, '沐浴': 7, '冠帯': 10, '建禄': 11,
  '帝旺': 12, '衰': 8, '病': 4, '死': 2, '墓': 5, '絶': 1
};